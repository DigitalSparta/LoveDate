<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—à–µ –°–≤–∏–¥–∞–Ω–∏–µ ‚ù§Ô∏è</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; background-size: cover; background-position: center; }
        .hidden { display: none !important; }

        /* 1. –í–•–û–î */
        #login-screen { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); z-index: 30; }
        #login-screen h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); font-size: 2.5rem; margin-bottom: 30px; }
        #login-screen input { padding: 15px; border-radius: 30px; border: none; width: 80%; max-width: 300px; text-align: center; font-size: 18px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { padding: 15px 40px; border-radius: 30px; background: #ff6b6b; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.95); }

        /* 2. –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø */
        #custom-screen { background: #fff0f5; z-index: 20; padding: 20px; box-sizing: border-box; }
        #char-preview-container { 
            position: relative; width: 260px; height: 350px; 
            background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            margin-bottom: 20px; overflow: hidden; border: 2px solid #ffcccc;
        }
        
        /* –°–ª–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        .char-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }

        .controls-row { display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 300px; margin-bottom: 10px; background: white; padding: 5px; border-radius: 15px; }
        .arrow-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #555; }
        .label-text { font-weight: bold; color: #555; }

        /* 3. –ò–ì–†–ê (–†–ï–°–¢–û–†–ê–ù) */
        #game-screen { background: #333; z-index: 10; justify-content: flex-start; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (–°—á–µ—Ç) */
        #stats-bar { width: 100%; height: 60px; background: rgba(255,255,255,0.9); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 5; }
        .stat-item { font-size: 18px; font-weight: bold; }

        /* –°—Ü–µ–Ω–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ */
        #restaurant-view { flex: 2; width: 100%; position: relative; background: #eee; overflow: hidden; }
        /* –§–æ–Ω —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ - –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç, –±—É–¥–µ—Ç —Ä–æ–∑–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
        #bg-image { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .bg-fallback { background: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); width: 100%; height: 100%; position: absolute; }

        /* –ò–≥—Ä–æ–∫–∏ –Ω–∞ —Å—Ü–µ–Ω–µ */
        .player-container { position: absolute; bottom: 40px; width: 140px; height: 200px; transition: all 0.5s; }
        .player-left { left: 15%; } 
        .player-right { right: 15%; transform: scaleX(-1); } /* –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∑–µ—Ä–∫–∞–ª—å–Ω–æ */
        .player-name { position: absolute; top: -30px; width: 100%; text-align: center; background: rgba(255,255,255,0.8); padding: 4px 0; border-radius: 10px; font-size: 14px; font-weight: bold; transform: scaleX(1) !important; /* –ò–º—è –Ω–µ –∑–µ—Ä–∫–∞–ª–∏—Ç—å */ }
        /* –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —Å–ø—Ä–∞–≤–∞, –∏–º—è –Ω—É–∂–Ω–æ "—Ä–∞–∑–∑–µ—Ä–∫–∞–ª–∏—Ç—å" –æ–±—Ä–∞—Ç–Ω–æ */
        .player-right .player-name { transform: scaleX(-1); }

        /* –ß–∞—Ç –∏ –∫–Ω–æ–ø–∫–∏ */
        #ui-layer { flex: 1.5; background: white; display: flex; flex-direction: column; width: 100%; border-top-left-radius: 20px; border-top-right-radius: 20px; overflow: hidden; }
        #actions-scroll { display: flex; overflow-x: auto; padding: 10px; gap: 10px; background: #f9f9f9; border-bottom: 1px solid #eee; }
        .action-btn { padding: 10px 15px; border: none; border-radius: 15px; background: #fff; border: 1px solid #ddd; white-space: nowrap; cursor: pointer; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-love { background: #ffe6e6; border-color: #ffcccc; color: #d63031; }
        .btn-food { background: #fff3cd; border-color: #ffeeba; color: #856404; }
        .btn-work { background: #d4edda; border-color: #c3e6cb; color: #155724; }

        #messages { flex-grow: 1; overflow-y: auto; padding: 15px; list-style: none; margin: 0; background: #fff; }
        .msg { padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; max-width: 80%; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg-mine { background: #ffcccc; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-theirs { background: #f1f0f0; margin-right: auto; border-bottom-left-radius: 2px; }
        .msg-system { text-align: center; color: #888; font-size: 12px; width: 100%; max-width: 100%; background: transparent; }

        #chat-form { display: flex; padding: 10px; border-top: 1px solid #eee; background: #fff; }
        #chat-input { flex-grow: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; outline: none; }
        #chat-send { margin-left: 10px; padding: 0 20px; background: #ff6b6b; color: white; border: none; border-radius: 20px; cursor: pointer; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —ç–º–æ–¥–∑–∏ */
        .floating-emoji { position: absolute; font-size: 40px; animation: floatUp 2s ease-out forwards; pointer-events: none; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }

    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1>‚ù§Ô∏è Love Date ‚ù§Ô∏è</h1>
        <input id="username" placeholder="–¢–≤–æ–µ –∏–º—è..." autocomplete="off" />
        <button class="btn-primary" onclick="goToCustomization()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>

    <div id="custom-screen" class="screen hidden">
        <h2 style="color: #444; margin-bottom: 10px;">–ö–∞–∫ —Ç—ã –≤—ã–≥–ª—è–¥–∏—à—å?</h2>
        
        <div id="char-preview-container">
            <img id="layer-body" class="char-layer" src="" onerror="this.style.display='none'">
            <img id="layer-clothes" class="char-layer" src="" onerror="this.style.display='none'">
            <img id="layer-head" class="char-layer" src="" onerror="this.style.display='none'">
        </div>

        <div class="controls-row">
            <button class="arrow-btn" onclick="changeAsset('body', -1)">‚óÄ</button>
            <span class="label-text">–¢–µ–ª–æ / –ü–æ–ª</span>
            <button class="arrow-btn" onclick="changeAsset('body', 1)">‚ñ∂</button>
        </div>
        <div class="controls-row">
            <button class="arrow-btn" onclick="changeAsset('clothes', -1)">‚óÄ</button>
            <span class="label-text">–û–¥–µ–∂–¥–∞</span>
            <button class="arrow-btn" onclick="changeAsset('clothes', 1)">‚ñ∂</button>
        </div>
        <div class="controls-row">
            <button class="arrow-btn" onclick="changeAsset('head', -1)">‚óÄ</button>
            <span class="label-text">–ü—Ä–∏—á–µ—Å–∫–∞</span>
            <button class="arrow-btn" onclick="changeAsset('head', 1)">‚ñ∂</button>
        </div>

        <button class="btn-primary" style="margin-top: 20px;" onclick="startGame()">–ü–æ–π—Ç–∏ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω üåπ</button>
    </div>

    <div id="game-screen" class="screen hidden">
        
        <div id="stats-bar">
            <div class="stat-item">üí∞ <span id="money-display">0</span>$</div>
            <div class="stat-item">‚ù§Ô∏è <span id="happiness-display">50</span>%</div>
        </div>

        <div id="restaurant-view">
            <div class="bg-fallback"></div>
            <img id="bg-image" src="assets/bg.png" onerror="this.style.display='none'"> 
            
            </div>

        <div id="ui-layer">
            <div id="actions-scroll">
                <button class="action-btn btn-food" onclick="sendAction('üç∑ –ó–∞–∫–∞–∑–∞–ª –≤–∏–Ω–æ')">üç∑ –í–∏–Ω–æ</button>
                <button class="action-btn btn-food" onclick="sendAction('ü•© –ó–∞–∫–∞–∑–∞–ª —Å—Ç–µ–π–∫')">ü•© –°—Ç–µ–π–∫</button>
                <button class="action-btn btn-food" onclick="sendAction('üç∞ –î–µ—Å–µ—Ä—Ç–∏–∫')">üç∞ –î–µ—Å–µ—Ä—Ç</button>
                <button class="action-btn btn-love" onclick="sendAction('üòò –ü–æ—Ü–µ–ª–æ–≤–∞–ª')">üòò –ß–º–æ–∫</button>
                <button class="action-btn btn-love" onclick="sendAction('üíÉ –ü—Ä–∏–≥–ª–∞—Å–∏–ª —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å')">üíÉ –¢–∞–Ω–µ—Ü</button>
                <button class="action-btn btn-work" onclick="doWork()">üí∏ –†–∞–±–æ—Ç–∞—Ç—å (+15$)</button>
            </div>

            <ul id="messages"></ul>

            <form id="chat-form">
                <input id="chat-input" autocomplete="off" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." />
                <button id="chat-send">Send</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "";
        let money = 0;
        let happiness = 50;
        
        // --- –ù–ê–°–¢–†–û–ô–ö–ê –§–ê–ô–õ–û–í (–ò–º–µ–Ω–∞ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –≤ –ø–∞–ø–∫–µ assets) ---
        const assetsConfig = {
            // "assets/" –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ updatePreview
            body: ['body_boy.png', 'body_girl.png'], 
            clothes: ['outfit1.png', 'outfit2.png', 'outfit3.png'],
            head: ['head1.png', 'head2.png', 'head3.png'] 
        };

        let currentLook = { body: 0, clothes: 0, head: 0 };

        // 1. –õ–û–ì–ò–ù -> –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø
        function goToCustomization() {
            const input = document.getElementById('username');
            if(!input.value.trim()) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∏–º—è!");
            myName = input.value.trim();
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('custom-screen').classList.remove('hidden');
            updatePreview();
        }

        // 2. –õ–û–ì–ò–ö–ê –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–ò
        function changeAsset(type, dir) {
            const arr = assetsConfig[type];
            currentLook[type] += dir;
            if (currentLook[type] >= arr.length) currentLook[type] = 0;
            if (currentLook[type] < 0) currentLook[type] = arr.length - 1;
            updatePreview();
        }

        function updatePreview() {
            const path = "assets/"; // –ü–∞–ø–∫–∞, –≥–¥–µ –ª–µ–∂–∞—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏
            
            setImageSafe('layer-body', path + assetsConfig.body[currentLook.body]);
            setImageSafe('layer-clothes', path + assetsConfig.clothes[currentLook.clothes]);
            setImageSafe('layer-head', path + assetsConfig.head[currentLook.head]);
        }

        // –§—É–Ω–∫—Ü–∏—è "–±–µ–∑–æ–ø–∞—Å–Ω–æ–π" —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (—Å–∫—Ä—ã–≤–∞–µ—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç)
        function setImageSafe(id, src) {
            const img = document.getElementById(id);
            img.style.display = 'block'; // –°–±—Ä–æ—Å —Å–∫—Ä—ã—Ç–∏—è
            img.src = src;
        }

        // 3. –°–¢–ê–†–¢ –ò–ì–†–´
        function startGame() {
            document.getElementById('custom-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä—É –Ω–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
            socket.emit('join_game', { name: myName, look: currentLook });
        }

        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---

        // –î–µ–π—Å—Ç–≤–∏—è (–∫–Ω–æ–ø–∫–∏)
        function sendAction(text) {
            socket.emit('chat_message', "‚ú® " + text);
            spawnEmoji("üíñ");
            happiness += 5;
            updateStats();
        }

        // –†–∞–±–æ—Ç–∞
        function doWork() {
            money += 15;
            updateStats();
            spawnEmoji("üíµ");
            // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø–∞–º–∏—Ç—å –≤ —á–∞—Ç
        }

        function updateStats() {
            document.getElementById('money-display').textContent = money;
            document.getElementById('happiness-display').textContent = happiness;
        }

        function spawnEmoji(char) {
            const el = document.createElement('div');
            el.textContent = char;
            el.className = 'floating-emoji';
            // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
            el.style.left = (Math.random() * 60 + 20) + "%";
            el.style.bottom = "150px";
            document.getElementById('restaurant-view').appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // --- –°–û–ö–ï–¢–´ (–°–ï–¢–¨) ---

        // –ö—Ç–æ-—Ç–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è (–∏–ª–∏ —è —Å–∞–º, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å–ø–∏—Å–æ–∫)
        socket.on('player_joined', (player) => {
            renderPlayer(player);
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ
        function renderPlayer(player) {
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –µ—Å—Ç—å, –Ω–µ —Ä–∏—Å—É–µ–º –¥—É–±–ª—å
            if(document.getElementById('p-' + player.name)) return;

            const div = document.createElement('div');
            div.id = 'p-' + player.name;
            div.className = 'player-container';
            
            // –ü–æ–∑–∏—Ü–∏—è: –ï—Å–ª–∏ —ç—Ç–æ —è - —Å–ª–µ–≤–∞. –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π - —Å–ø—Ä–∞–≤–∞.
            if(player.name === myName) {
                div.classList.add('player-left');
            } else {
                div.classList.add('player-right');
            }

            const path = "assets/";
            
            // –°–æ–±–∏—Ä–∞–µ–º HTML –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            div.innerHTML = `
                <div class="player-name">${player.name}</div>
                <img class="char-layer" src="${path + assetsConfig.body[player.look.body]}" onerror="this.style.display='none'">
                <img class="char-layer" src="${path + assetsConfig.clothes[player.look.clothes]}" onerror="this.style.display='none'">
                <img class="char-layer" src="${path + assetsConfig.head[player.look.head]}" onerror="this.style.display='none'">
            `;
            
            document.getElementById('restaurant-view').appendChild(div);
        }

        // –ß–∞—Ç
        const chatForm = document.getElementById('chat-form');
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                socket.emit('chat_message', input.value.trim());
                input.value = '';
            }
        });

        socket.on('chat_message', (data) => {
            const ul = document.getElementById('messages');
            const li = document.createElement('li');
            li.classList.add('msg');
            
            if(data.user === 'System') {
                li.classList.add('msg-system');
                li.textContent = data.text;
            } else {
                li.textContent = data.text; // –°–Ω–∞—á–∞–ª–∞ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –¥–ª–∏–Ω—É
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è
                const nameSpan = document.createElement('strong');
                nameSpan.textContent = data.user + ": ";
                li.prepend(nameSpan);

                if(data.user === myName) li.classList.add('msg-mine');
                else li.classList.add('msg-theirs');
            }
            
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        });

    </script>
</body>
</html>
